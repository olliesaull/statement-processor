{% extends "base.html" %}
{% block title %}Edit Contact Config{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Edit Contact Config</h1>

  <div class="mb-4">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#exampleConfig" aria-expanded="false" aria-controls="exampleConfig">
      View example config
    </button>
  </div>

  <div class="collapse mb-4" id="exampleConfig">
    <div class="card">
      <div class="card-header">How the PDF lines up with a config</div>
      <div class="card-body">
        <div class="row g-4 align-items-start">
          <div class="col-lg-6">
            <img src="{{ url_for('static', filename='assets/images/sample_statement.png') }}" class="img-fluid border rounded" alt="Sample PDF statement layout">
          </div>
          <div class="col-lg-6">
            <div class="table-responsive">
              {% if example_rows %}
              <table class="table table-bordered table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width: 55%">Xero field</th>
                    <th>Statement column</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in example_rows %}
                  {% set field_key = row['field'] %}
                  {% set field_label_raw = (field_key or '').replace('_', ' ') %}
                  {% set field_label = field_label_raw.title() %}
                  {% if field_key == 'number' %}
                  {% set field_label = field_label + ' (Mandatory)' %}
                  {% endif %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ field_label }}</div>
                      {% set desc = field_descriptions.get(field_key) if field_descriptions else None %}
                      {% if desc %}
                      <div class="text-muted small mt-1">{{ desc }}</div>
                      {% endif %}
                    </td>
                    <td>
                      {% set values = row['values'] or [] %}
                      {% if row['is_multi'] %}
                        {% if values %}
                          {% for value in values %}
                          <div class="input-group mb-2">
                            <input type="text" class="form-control" value="{{ value }}" placeholder="Enter column heading" disabled>
                            <button type="button" class="btn btn-outline-danger" disabled>Remove</button>
                          </div>
                          {% endfor %}
                        {% else %}
                          <div class="input-group mb-2">
                            <input type="text" class="form-control" value="" placeholder="Enter column heading" disabled>
                            <button type="button" class="btn btn-outline-danger" disabled>Remove</button>
                          </div>
                        {% endif %}
                        <button type="button" class="btn btn-sm btn-outline-secondary" disabled>Add another column</button>
                      {% else %}
                        <input type="text" class="form-control" value="{{ values[0] if values else '' }}" placeholder="Enter column heading" disabled>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              {% endif %}
              <p>Due Date is empty as it is not present in the statement.</p>
              <div class="mt-3">
                <h3 class="h6">Formatting used in this example</h3>
                <dl class="row small mb-0">
                  <dt class="col-sm-6">Date format</dt>
                  <dd class="col-sm-6"><code>{{ example_date_format or 'Not set' }}</code></dd>
                  <dt class="col-sm-6">Decimal separator</dt>
                  <dd class="col-sm-6">{{ decimal_separator_labels.get(example_decimal_separator, example_decimal_separator or 'Not set') }}</dd>
                  <dt class="col-sm-6">Thousands separator</dt>
                  <dd class="col-sm-6">{{ thousands_separator_labels.get(example_thousands_separator, example_thousands_separator or 'Not set') }}</dd>
                </dl>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if message %}
  <div class="alert alert-success" role="alert">{{ message }}</div>
  {% endif %}
  {% if error %}
  <div class="alert alert-danger" role="alert">{{ error }}</div>
  {% endif %}

  <!-- Contact selector -->
  <form method="POST" action="{{ url_for('configs') }}" class="mb-4">
    <fieldset class="row gy-2 gx-3 align-items-center">
      <input type="hidden" name="action" value="load">
      <div class="col-auto">
        <label class="visually-hidden" for="contactInput">Contact</label>
        <input type="text" id="contactInput" name="contact_name" class="form-control"
               placeholder="Select contact" list="contacts-list" autocomplete="off"
               value="{{ selected_contact_name or '' }}" style="min-width: 320px;">
        <datalist id="contacts-list">
          {% for c in contacts %}
          <option value="{{ c['name'] }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">Load Config</button>
      </div>
    </fieldset>
  </form>

  {% if selected_contact_id %}
  <form method="POST" action="{{ url_for('configs') }}">
    <fieldset>
    <input type="hidden" name="action" value="save_map">
    <input type="hidden" name="contact_id" value="{{ selected_contact_id }}">
    <input type="hidden" name="contact_name" value="{{ selected_contact_name }}">

    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th style="width: 60%">Xero</th>
            <th>Statement column</th>
          </tr>
        </thead>
        <tbody>
          {% for row in mapping_rows %}
          {% set field_key = row.field %}
          {% set field_label_raw = field_key.replace('_', ' ') %}
          {% set field_label = field_label_raw.title() %}
          {% if field_key == 'number' %}
          {% set field_label = field_label + ' (Mandatory)' %}
          {% endif %}
          <tr>
            <td>
              <div class="fw-semibold">{{ field_label }}</div>
              {% set desc = field_descriptions.get(field_key) if field_descriptions else None %}
              {% if desc %}
              <div class="text-muted small mt-1">{{ desc }}</div>
              {% endif %}
            </td>
            <td>
              <input type="hidden" name="fields[]" value="{{ field_key }}">
              {% set values = row['values'] or [] %}
              {% if row.is_multi %}
              <div id="container-{{ field_key }}">
                {% for v in values %}
                <div class="input-group mb-2">
                  <input type="text" class="form-control" name="map[{{ field_key }}][]" value="{{ v }}" placeholder="Enter column heading">
                  <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Remove</button>
                </div>
                {% endfor %}
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addInput('{{ field_key }}')">Add another column</button>
              {% else %}
              <input type="text" class="form-control" name="map[{{ field_key }}]" value="{{ values[0] if values else '' }}" placeholder="Enter column heading" {% if field_key == 'number' %}required{% endif %}>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-4">
      <h2 class="h5">Formatting</h2>
      <p class="text-muted small mb-3">Tell us how this supplier prints dates and numbers so we can parse the statement correctly.</p>
      <div class="row g-3">
        <div class="col-md-6 col-lg-4">
          <label for="dateFormat" class="form-label">Date format</label>
          <input type="text" id="dateFormat" name="date_format" class="form-control" value="{{ date_format }}" placeholder="e.g. DD/MM/YYYY">
          <div class="form-text">{{ field_descriptions.get('date_format') }}</div>
        </div>
        <div class="col-md-6 col-lg-4">
          <label for="decimalSeparator" class="form-label">Decimal separator</label>
          <select id="decimalSeparator" name="decimal_separator" class="form-select">
            {% for value, label in decimal_separator_options %}
            <option value="{{ value }}" {% if decimal_separator == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Choose the character that separates the decimal portion of the number.</div>
        </div>
        <div class="col-md-6 col-lg-4">
          <label for="thousandsSeparator" class="form-label">Thousands separator</label>
          <select id="thousandsSeparator" name="thousands_separator" class="form-select">
            {% for value, label in thousands_separator_options %}
            <option value="{{ value }}" {% if thousands_separator == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Select "None" if large numbers are printed without separators.</div>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <h2 class="h5">Supplier Date Format (SDF) reference</h2>
      <p>Use the following tokens when describing how your supplier prints dates:</p>
      <ul class="mb-3">
        <li><code>YYYY</code> / <code>YY</code> - four-digit year / two-digit year (assumed 2000-2099)</li>
        <li><code>M</code>, <code>MM</code> - month number (1-12 / 01-12, zero-padded)</li>
        <li><code>MMM</code>, <code>MMMM</code> - abbreviated / full month name</li>
        <li><code>D</code>, <code>DD</code> - day of month (1-31 / 01-31, zero-padded)</li>
        <li><code>Do</code> - day with ordinal suffix (1st, 2nd, …)</li>
      </ul>
      <p class="mb-3">Wrap optional literals in square brackets to ignore them if present (for example, <code>[dddd, ]D MMM YYYY</code> matches both <code>Friday, 01 Aug 2025</code> and <code>01 Aug 2025</code>). Separators such as spaces, slashes, dashes, dots, and commas can be written directly.</p>
      <p class="mb-1 fw-semibold">Examples</p>
      <ul class="mb-3">
        <li><code>01 Aug 2025 / 1 Aug 2025</code> → <code>DD MMM YYYY / D MMM YYYY</code></li>
        <li><code>08/01/25</code> → <code>MM/DD/YY</code></li>
        <li><code>2025-08-01</code> → <code>YYYY-MM-DD</code></li>
        <li><code>1st Aug, 2025</code> → <code>Do MMM, YYYY</code></li>
        <li><code>Fri, 01 Aug 2025</code> → <code>[dddd, ]D MMM YYYY</code></li>
        <li><code>01.08.2025</code> → <code>DD.MM.YYYY</code></li>
      </ul>
    </div>

    <button type="submit" class="btn btn-success mb-5">Save</button>
    </fieldset>
  </form>
  {% endif %}

</div>

<script>
function addInput(field) {
  const container = document.getElementById('container-' + field);
  if (!container) return;
  const wrapper = document.createElement('div');
  wrapper.className = 'input-group mb-2';
  wrapper.innerHTML = `
    <input type="text" class="form-control" name="map[${field}][]" placeholder="Enter column heading">
    <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Remove</button>
  `;
  container.appendChild(wrapper);
}
</script>
{% endblock %}
