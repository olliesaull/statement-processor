{% extends "base.html" %}
{% block title %}Upload Statements{% endblock %}

{% block content %}
<div class="d-flex flex-column align-items-center" style="margin-top: 10vh;">
  <h1>Upload Statements</h1>
  {% if success_count %}
    <div class="alert alert-success w-100" style="max-width: 720px;">
      Uploaded {{ success_count }} statement{% if success_count != 1 %}s{% endif %} successfully.
    </div>
  {% endif %}
  {% if error_messages %}
    <div class="alert alert-danger w-100" style="max-width: 720px;">
      <ul class="mb-0">
        {% for message in error_messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="POST" action="{{ url_for('upload_statements') }}" enctype="multipart/form-data" class="mt-3 upload-statements-form" id="upload-statements-form" style="max-width: 720px; width: 100%;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <fieldset>
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width:45%;">Statement (PDF)</th>
            <th style="width:45%;">Contact</th>
            <th style="width:10%;"></th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr>
            <td>
              <input type="file" name="statements" class="form-control statement-file-input" accept="application/pdf,.pdf" data-automation="statement-upload-file" required>
            </td>
            <td>
              <input type="text" name="contact_names" class="form-control contact-input" placeholder="Select contact"
                list="contacts-list" autocomplete="off" data-automation="statement-upload-contact" required>
            </td>
            <td class="text-end">
              <button type="button" class="btn btn-outline-danger btn-sm remove-row"
                aria-label="Remove row">Remove</button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- One shared datalist for all contact inputs -->
      <datalist id="contacts-list">
        {% for contact in contacts %}
        <option value="{{ contact['name'] }}"></option>
        {% endfor %}
      </datalist>

      <div class="d-flex gap-2">
        <button id="add-row" type="button" class="btn btn-outline-secondary" data-automation="statement-upload-add">Add statement</button>
        <button type="submit" class="btn btn-primary" data-automation="statement-upload-submit">Upload</button>
      </div>
    </fieldset>
  </form>
</div>

<script>
  const rows = document.getElementById('rows');
  const addBtn = document.getElementById('add-row');

  function makeRow() {
    const tr = document.createElement('tr');

    tr.innerHTML = `
        <td>
          <input type="file"
                 name="statements"
                 class="form-control statement-file-input"
                 accept="application/pdf,.pdf"
                 data-automation="statement-upload-file"
                 required>
        </td>
        <td>
          <input type="text"
                 name="contact_names"
                 class="form-control contact-input"
                 placeholder="Select contact"
                 list="contacts-list"
                 autocomplete="off"
                 data-automation="statement-upload-contact"
                 required>
        </td>
        <td class="text-end">
          <button type="button" class="btn btn-outline-danger btn-sm remove-row" aria-label="Remove row">Remove</button>
        </td>
      `;
    return tr;
  }

  function onTableClick(e) {
    if (e.target && e.target.classList.contains('remove-row')) {
      const tr = e.target.closest('tr');
      if (tr) tr.remove();
    }
  }

  if (addBtn) {
    addBtn.addEventListener('click', () => rows.appendChild(makeRow()));
  }
  if (rows) {
    rows.addEventListener('click', onTableClick);
  }
</script>
{% endblock %}
