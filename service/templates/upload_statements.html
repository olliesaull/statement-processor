{% extends "base.html" %}
{% block title %}Upload Statements{% endblock %}

{% block content %}
<div class="page-main upload-statements-page">
  <header class="page-header content-max-720">
    <p class="page-kicker mb-1">Statements</p>
    <h1 class="mb-2">Upload Statements</h1>
    <p class="page-subtitle mb-0">Add one or more statement PDFs and pair each file with the correct contact before upload.</p>
  </header>

  {% if success_count %}
    <div class="alert alert-success w-100 content-max-720" role="alert">
      Uploaded {{ success_count }} statement{% if success_count != 1 %}s{% endif %} successfully.
    </div>
  {% endif %}
  {% if error_messages %}
    <div class="alert alert-danger w-100 content-max-720" role="alert">
      <ul class="mb-0">
        {% for message in error_messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="POST" action="{{ url_for('upload_statements') }}" enctype="multipart/form-data" class="content-max-720" id="upload-statements-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <fieldset class="page-panel">
      <table class="table table-sm align-middle upload-statements-table mb-3">
        <thead>
          <tr>
            <th class="upload-column-file">Statement (PDF)</th>
            <th class="upload-column-contact">Contact</th>
            <th class="upload-column-actions"></th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr>
            <td>
              <input type="file" name="statements" class="form-control statement-file-input" accept="application/pdf,.pdf" data-automation="statement-upload-file" required>
            </td>
            <td>
              <input type="text" name="contact_names" class="form-control contact-input" placeholder="Select contact"
                list="contacts-list" autocomplete="off" data-automation="statement-upload-contact" required>
            </td>
            <td class="text-end">
              <button type="button" class="btn btn-outline-danger btn-sm remove-row"
                aria-label="Remove row">Remove</button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- One shared datalist for all contact inputs -->
      <datalist id="contacts-list">
        {% for contact in contacts %}
        <option value="{{ contact['name'] }}"></option>
        {% endfor %}
      </datalist>

      <div class="d-flex flex-wrap gap-2">
        <button id="add-row" type="button" class="btn btn-outline-secondary" data-automation="statement-upload-add">Add statement</button>
        <button type="submit" class="btn btn-primary" data-automation="statement-upload-submit">Upload</button>
      </div>
    </fieldset>
  </form>
</div>

<script>
  const rowsContainer = document.getElementById("rows");
  const addRowButton = document.getElementById("add-row");

  function createRow() {
    const tr = document.createElement('tr');

    tr.innerHTML = `
        <td>
          <input type="file"
                 name="statements"
                 class="form-control statement-file-input"
                 accept="application/pdf,.pdf"
                 data-automation="statement-upload-file"
                 required>
        </td>
        <td>
          <input type="text"
                 name="contact_names"
                 class="form-control contact-input"
                 placeholder="Select contact"
                 list="contacts-list"
                 autocomplete="off"
                 data-automation="statement-upload-contact"
                 required>
        </td>
        <td class="text-end">
          <button type="button" class="btn btn-outline-danger btn-sm remove-row" aria-label="Remove row">Remove</button>
        </td>
      `;
    return tr;
  }

  function handleTableClick(event) {
    const removeButton = event.target.closest(".remove-row");
    if (!removeButton) return;
    removeButton.closest("tr")?.remove();
  }

  if (addRowButton && rowsContainer) {
    addRowButton.addEventListener("click", () => rowsContainer.appendChild(createRow()));
    rowsContainer.addEventListener("click", handleTableClick);
  }
</script>
{% endblock %}
