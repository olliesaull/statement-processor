{% extends "base.html" %}
{% block title %}Upload Statements{% endblock %}

{% block content %}
<div class="d-flex flex-column align-items-center" style="margin-top: 10vh;">
  <h1>Upload Statements</h1>
  {% if error_messages %}
    <div class="alert alert-danger w-100" style="max-width: 720px;">
      {% if error_messages|length == 1 %}
        {{ error_messages[0] }}
      {% else %}
        <ul class="mb-0">
          {% for err in error_messages %}
          <li>{{ err }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  {% endif %}

  {% if success_count %}
    <div class="alert alert-success w-100" style="max-width: 720px;">
      Uploaded {{ success_count }} statement{% if success_count != 1 %}s{% endif %} successfully.
    </div>
  {% endif %}
  {% set sync = contact_sync_status or {} %}
  {% if sync.status == 'error' %}
    <div class="alert alert-warning w-100" style="max-width: 720px;" role="alert">
      Contacts are temporarily unavailable. Please try again once the sync resumes.
    </div>
  {% elif not contacts_ready %}
    <div class="alert alert-info w-100 d-flex align-items-center gap-2" style="max-width: 720px;" role="alert">
      <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
      <span>Synchronising contacts{% if sync.synced_count %}: {{ sync.synced_count }} loaded{% endif %}. Uploads will be enabled once this completes.</span>
    </div>
  {% endif %}

  <form method="POST" action="{{ url_for('upload_statements') }}" enctype="multipart/form-data" class="mt-3"
    style="max-width: 720px; width: 100%;">
    <fieldset {% if not contacts_ready %}disabled{% endif %}>
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width:45%;">Statement (PDF)</th>
            <th style="width:45%;">Contact</th>
            <th style="width:10%;"></th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr>
            <td>
              <input type="file" name="statements" class="form-control" accept="application/pdf,.pdf" required>
            </td>
            <td>
              <input type="text" name="contact_names" class="form-control" placeholder="Select contact"
                list="contacts-list" autocomplete="off" required>
            </td>
            <td class="text-end">
              <button type="button" class="btn btn-outline-danger btn-sm remove-row"
                aria-label="Remove row">Remove</button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- One shared datalist for all contact inputs -->
      <datalist id="contacts-list">
        {% for contact in contacts %}
        <option value="{{ contact['name'] }}"></option>
        {% endfor %}
      </datalist>

      <div class="d-flex gap-2">
        <button id="add-row" type="button" class="btn btn-outline-secondary">Add statement</button>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </fieldset>
    {% if sync.status == 'error' %}
      <p class="text-muted small mt-2">We cannot load contacts right now. Please refresh in a moment.</p>
    {% elif not contacts_ready %}
      <p class="text-muted small mt-2">We will enable uploads as soon as the contact sync finishes.</p>
    {% endif %}
  </form>
</div>

<script>
  const rows = document.getElementById('rows');
  const addBtn = document.getElementById('add-row');

  function makeRow() {
    const tr = document.createElement('tr');

    tr.innerHTML = `
        <td>
          <input type="file"
                 name="statements"
                 class="form-control"
                 accept="application/pdf,.pdf"
                 required>
        </td>
        <td>
          <input type="text"
                 name="contact_names"
                 class="form-control"
                 placeholder="Select contact"
                 list="contacts-list"
                 autocomplete="off"
                 required>
        </td>
        <td class="text-end">
          <button type="button" class="btn btn-outline-danger btn-sm remove-row" aria-label="Remove row">Remove</button>
        </td>
      `;
    return tr;
  }

  function onTableClick(e) {
    if (e.target && e.target.classList.contains('remove-row')) {
      const tr = e.target.closest('tr');
      if (tr) tr.remove();
    }
  }

  if (addBtn) {
    addBtn.addEventListener('click', () => rows.appendChild(makeRow()));
  }
  if (rows) {
    rows.addEventListener('click', onTableClick);
  }
</script>
{% if sync.status != 'ready' %}
<script>
  (function pollContactSync() {
    const retry = (delayMs) => setTimeout(pollContactSync, delayMs);
    fetch("{{ url_for('contact_sync_status_api') }}", { headers: { 'Accept': 'application/json' } })
      .then((resp) => resp.ok ? resp.json() : null)
      .then((data) => {
        if (!data) {
          console.warn('Contact sync poll returned no data');
          return retry(10000);
        }
        if (data.status === 'ready') {
          window.location.reload();
          return;
        }
        if (data.status === 'error') {
          console.warn('Contact sync still reporting error');
        }
        retry(5000);
      })
      .catch((err) => {
        console.error('Contact sync poll failed', err);
        retry(10000);
      });
  })();
</script>
{% endif %}
{% endblock %}
