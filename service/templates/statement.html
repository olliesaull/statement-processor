{% extends "base.html" %}
{% block title %}Statement {{ statement_id }}{% endblock %}

{% block content %}
  <div class="container mt-4">
    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3 mb-4">
      <h1 class="mb-0">Statement {{ statement_id }}</h1>
      {% if not is_processing %}
        <a
          class="btn btn-outline-primary"
          href="{{ url_for('statement', statement_id=statement_id, download='csv') }}"
        >Download CSV</a>
      {% endif %}
    </div>

    {% if is_processing %}
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <p class="mt-3 mb-1">We're still preparing this statement.</p>
        <p class="text-muted mb-0">This page will refresh automatically in a few seconds.</p>
      </div>
      <script>
        setTimeout(function () { window.location.reload(); }, 5000);
      </script>
    {% else %}
      <div class="row g-4">
        <!-- Left column: raw statement table -->
        <div class="col-12 col-lg-6">
          <h2>Statement Items</h2>
          <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  {% for h in raw_statement_headers %}
                    <th>{{ h|capitalize }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% if raw_statement_rows %}
                  {% for row in raw_statement_rows %}
                    {% set idx = loop.index0 %}
                    <tr class="{{ 'table-success' if row_matches[idx] else 'table-danger' }}">
                      {% for h in raw_statement_headers %}
                        <td>{{ row[loop.index0] }}</td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="{{ raw_statement_headers|length }}" class="text-center text-muted">
                      No raw data found.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Right column: same headers, values from Xero invoice -->
        <div class="col-12 col-lg-6">
          <h2>Xero Items</h2>
          <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  {% for h in raw_statement_headers %}
                    <th>{{ h|capitalize }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% if raw_statement_rows %}
                  {% for row in raw_statement_rows %}
                    {% set idx = loop.index0 %}
                    <tr class="{{ 'table-success' if row_matches[idx] else 'table-danger' }}">
                      {% for h in raw_statement_headers %}
                        <td>{{ right_rows_by_header[idx][h] }}</td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="{{ raw_statement_headers|length }}" class="text-center text-muted">
                      No invoice data found.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mt-4">
        <a href="{{ url_for('statements') }}" class="btn btn-outline-secondary">Back to statements</a>
        <div class="d-flex align-items-center gap-3">
          {% if is_completed %}
            <span class="badge bg-success fs-6">Completed</span>
            <form method="post" class="mb-0">
              <input type="hidden" name="action" value="mark_incomplete">
              <button type="submit" class="btn btn-outline-warning">Mark incomplete</button>
            </form>
          {% else %}
            <form method="post" class="mb-0">
              <input type="hidden" name="action" value="mark_complete">
              <button type="submit" class="btn btn-success">Complete Statement</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}
