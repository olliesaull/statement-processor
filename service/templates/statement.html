{% extends "base.html" %}
{% block title %}Statement {{ statement_id }}{% endblock %}

{% block container_class %}container-fluid px-2 px-lg-4 py-4{% endblock %}

{% block content %}
    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3 mb-4">
      <div>
        <h1 class="mb-2 mb-md-0">Statement {{ statement_id }}</h1>
        {% if not is_processing %}
          <div class="btn-group" role="group" aria-label="Filter statement items">
            <a
              class="btn btn-sm {% if items_view == 'incomplete' %}btn-primary{% else %}btn-outline-primary{% endif %}"
              href="{{ url_for('statement', statement_id=statement_id, items_view='incomplete') }}"
            >Incomplete ({{ incomplete_count }})</a>
            <a
              class="btn btn-sm {% if items_view == 'completed' %}btn-primary{% else %}btn-outline-primary{% endif %}"
              href="{{ url_for('statement', statement_id=statement_id, items_view='completed') }}"
            >Completed ({{ completed_count }})</a>
            <a
              class="btn btn-sm {% if items_view == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}"
              href="{{ url_for('statement', statement_id=statement_id, items_view='all') }}"
            >All ({{ all_statement_rows|length }})</a>
          </div>
        {% endif %}
      </div>
      {% if not is_processing %}
        <a
          class="btn btn-outline-primary"
          href="{{ url_for('statement', statement_id=statement_id, download='csv', items_view=items_view) }}"
        >Download CSV</a>
      {% endif %}
    </div>

    {% if is_processing %}
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <p class="mt-3 mb-1">We're still preparing this statement. This can take anywhere from 5 seconds to 10 minutes.</p>
        <p class="text-muted mb-0">This page will refresh automatically in a few seconds.</p>
      </div>
      <script>
        setTimeout(function () { window.location.reload(); }, 5000);
      </script>
    {% else %}
      {% set statement_col_count = raw_statement_headers|length %}

      <div class="statement-legend d-flex flex-wrap align-items-center gap-3 small text-muted mb-3">
        <span class="legend-item d-flex align-items-center gap-2">
          <span class="legend-swatch bg-success"></span>Match
        </span>
        <span class="legend-item d-flex align-items-center gap-2">
          <span class="legend-swatch bg-danger"></span>Mismatch
        </span>
        <span class="legend-item d-flex align-items-center gap-2 text-dark">
          <span class="legend-swatch bg-warning"></span>Flagged anomaly
        </span>
        <span class="legend-item d-flex align-items-center gap-2">
          <span class="legend-swatch legend-swatch-faded"></span>Completed rows appear faded
        </span>
      </div>

      <div class="table-responsive statement-table-wrapper">
        <table class="table table-striped table-bordered align-middle table-fixed-height table-compare w-100">
          <thead class="table-light">
            <tr>
              <th class="split-right text-center" colspan="{{ statement_col_count }}">Statement</th>
              <th class="text-center" colspan="{{ statement_col_count }}">Xero</th>
              <th class="text-center" rowspan="2">Status</th>
            </tr>
            <tr>
              {% for h in raw_statement_headers %}
                <th class="{% if loop.last %}split-right{% endif %}">{{ h|capitalize }}</th>
              {% endfor %}
              {% for h in raw_statement_headers %}
                <th>{{ h|capitalize }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% if statement_rows %}
              {% for row in statement_rows %}
                {% set anomalous = 'ml-outlier' in (row.flags or []) %}
                {% set row_class = 'table-success' if row.matches else 'table-danger' %}
                {% if anomalous %}
                  {% set row_class = row_class + ' table-warning anomaly-row' %}
                {% endif %}
                {% if row.is_completed %}
                  {% set row_class = row_class + ' opacity-50' %}
                {% endif %}
                <tr class="{{ row_class }}">
                  {% for value in row.left_values %}
                    <td class="{% if loop.last %}split-right{% endif %}">{{ value }}</td>
                  {% endfor %}
                  {% for value in row.right_values %}
                    <td>{{ value }}</td>
                  {% endfor %}
                  <td class="text-center">
                    {% if row.statement_item_id %}
                      {% if row.is_completed %}
                        <form method="post" class="d-inline">
                          <input type="hidden" name="action" value="incomplete_item">
                          <input type="hidden" name="statement_item_id" value="{{ row.statement_item_id }}">
                          <input type="hidden" name="items_view" value="{{ items_view }}">
                          <button type="submit" class="btn btn-sm btn-outline-warning text-nowrap px-2 py-0">Mark incomplete</button>
                        </form>
                      {% else %}
                        <form method="post" class="d-inline">
                          <input type="hidden" name="action" value="complete_item">
                          <input type="hidden" name="statement_item_id" value="{{ row.statement_item_id }}">
                          <input type="hidden" name="items_view" value="{{ items_view }}">
                          <button type="submit" class="btn btn-sm btn-outline-success text-nowrap px-2 py-0">Mark complete</button>
                        </form>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">Unavailable</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="{{ statement_col_count * 2 + 1 }}" class="text-center text-muted">
                  {% if items_view == 'completed' %}
                    No completed statement items found.
                  {% elif items_view == 'incomplete' %}
                    No incomplete statement items found.
                  {% else %}
                    No statement items found.
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mt-4 mb-5">
        <a href="{{ url_for('statements') }}" class="btn btn-outline-secondary">Back to statements</a>
        <div class="d-flex align-items-center gap-3">
          {% if is_completed %}
            <span class="badge bg-success fs-6">Completed</span>
            <form method="post" class="mb-0">
              <input type="hidden" name="action" value="mark_incomplete">
              <button type="submit" class="btn btn-outline-warning text-nowrap px-3 py-1">Mark incomplete</button>
            </form>
          {% else %}
            <form method="post" class="mb-0">
              <input type="hidden" name="action" value="mark_complete">
              <button type="submit" class="btn btn-success text-nowrap px-3 py-1">Complete statement</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endif %}
{% endblock %}
