{% extends "base.html" %}
{% block title %}{{ page_heading }}{% endblock %}

{% block container_class %}container-fluid px-2 px-lg-4 py-4{% endblock %}

{% block content %}
    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3 mb-4">
      <div>
        <h1 class="mb-2 mb-md-0">{{ page_heading }}</h1>
        {% if not is_processing %}
          <div class="btn-group statement-filter-group" role="group" aria-label="Filter statement items">
            <a
              class="btn btn-sm {% if items_view == 'incomplete' %}btn-primary{% else %}btn-outline-primary{% endif %}"
              href="{{ url_for('statement', statement_id=statement_id, items_view='incomplete', show_payments='true' if show_payments else 'false') }}"
            >Incomplete ({{ incomplete_count }})</a>
            <a
              class="btn btn-sm {% if items_view == 'completed' %}btn-primary{% else %}btn-outline-primary{% endif %}"
              href="{{ url_for('statement', statement_id=statement_id, items_view='completed', show_payments='true' if show_payments else 'false') }}"
            >Completed ({{ completed_count }})</a>
            <a
              class="btn btn-sm {% if items_view == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}"
              href="{{ url_for('statement', statement_id=statement_id, items_view='all', show_payments='true' if show_payments else 'false') }}"
            >All ({{ all_statement_rows|length }})</a>
          </div>
          {% if has_payment_rows %}
            <div class="mt-2">
              <a
                class="btn btn-sm {% if show_payments %}btn-primary{% else %}btn-outline-primary{% endif %}"
                href="{{ url_for('statement', statement_id=statement_id, items_view=items_view, show_payments='false' if show_payments else 'true') }}"
              >
                {% if show_payments %}Hide payments{% else %}Show payments{% endif %}
              </a>
            </div>
          {% endif %}
        {% endif %}
      </div>
      {% if not is_processing %}
        <a
          class="btn btn-outline-primary"
          href="{{ url_for('statement', statement_id=statement_id, download='xlsx', items_view=items_view, show_payments='true' if show_payments else 'false') }}"
        >Download Excel</a>
      {% endif %}
    </div>

    {% if is_processing %}
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <p class="mt-3 mb-1">We're still preparing this statement. This can take anywhere from 5 seconds to 10 minutes.</p>
        <p class="text-muted mb-0">This page will refresh automatically analysis is complete.</p>
      </div>
      <script>
        setTimeout(function () { window.location.reload(); }, 5000);
      </script>
    {% else %}
      {% set statement_col_count = raw_statement_headers|length %}

      <div class="statement-legend d-flex flex-wrap align-items-center gap-3 small text-muted mb-3">
        <span class="legend-item d-flex align-items-center gap-2">
          <span class="legend-swatch bg-success"></span>Match
        </span>
        <span class="legend-item d-flex align-items-center gap-2">
          <span class="legend-swatch bg-danger"></span>Mismatch
        </span>
        <span class="legend-item d-flex align-items-center gap-2 text-dark">
          <span class="legend-swatch bg-warning"></span>Flagged anomaly
        </span>
        <span class="legend-item d-flex align-items-center gap-2">
          <span class="legend-indicator">!</span>Cell mismatch
        </span>
        <span class="legend-item d-flex align-items-center gap-2">
          <span class="legend-swatch legend-swatch-faded"></span>Completed rows appear faded
        </span>
      </div>

      <div class="table-responsive statement-table-wrapper">
        <table class="table table-striped table-bordered align-middle table-fixed-height table-compare w-100 statement-table" id="statement-table">
          <thead class="table-light">
            <tr>
              <th class="text-center col-type" rowspan="2">Type</th>
              <th class="split-right text-center" colspan="{{ statement_col_count }}">Statement</th>
              <th class="text-center" colspan="{{ statement_col_count }}">Xero</th>
              <th class="text-center" rowspan="2">Xero Link</th>
              <th class="text-center" rowspan="2">Status</th>
            </tr>
            <tr>
              {% for h in raw_statement_headers %}
                {% set header_class = "col-credit" if h|lower == "credit" else "" %}
                <th class="{% if loop.last %}split-right{% endif %}{% if header_class %} {{ header_class }}{% endif %}">{{ h|capitalize }}</th>
              {% endfor %}
              {% for h in raw_statement_headers %}
                {% set header_class = "col-credit" if h|lower == "credit" else "" %}
                <th class="{% if header_class %}{{ header_class }}{% endif %}">{{ h|capitalize }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody id="statement-table-body">
            {% if statement_rows %}
              {% for row in statement_rows %}
                {% set flag_list = row.flags or [] %}
                {% set has_ml_outlier = 'ml-outlier' in flag_list %}
                {% set has_invalid_date = 'invalid-date' in flag_list %}
                {% set anomalous = has_ml_outlier or has_invalid_date %}
                {% if anomalous %}
                  {% set row_class = 'table-warning anomaly-row' %}
                {% else %}
                  {% set row_class = 'table-success' if row.matches else 'table-danger' %}
                {% endif %}
                {% if row.is_completed %}
                  {% set row_class = row_class + ' opacity-50' %}
                {% endif %}
                <tr class="{{ row_class }}">
                  <td class="text-center col-type">{{ row.item_type_label }}</td>
                  {% set cells = row.cell_comparisons or [] %}
                  {% for cell in cells %}
                    <td class="{% if loop.last %}split-right{% endif %}{% if anomalous and not cell.matches %} anomaly-cell{% endif %}">
                      {% set stmt_text = cell.statement_value %}
                      {% set show_indicator = row.matches and not cell.matches %}
                      <span class="cell-value-wrapper">
                        <span class="cell-value-truncate" title="{{ stmt_text|default('', true)|e }}">{{ stmt_text }}</span>
                        {% if show_indicator %}
                          <span class="cell-indicator" title="Does not match Xero value">!</span>
                        {% endif %}
                      </span>
                    </td>
                  {% endfor %}
                  {% for cell in cells %}
                    <td class="{% if anomalous and not cell.matches %}anomaly-cell{% endif %}">
                      {% set xero_text = cell.xero_value %}
                      {% set show_indicator = row.matches and not cell.matches %}
                      <span class="cell-value-wrapper">
                        <span class="cell-value-truncate" title="{{ xero_text|default('', true)|e }}">{{ xero_text }}</span>
                        {% if show_indicator %}
                          <span class="cell-indicator" title="Does not match statement value">!</span>
                        {% endif %}
                      </span>
                    </td>
                  {% endfor %}
                  <td class="text-center">
                    {% if row.xero_credit_note_id %}
                      <a href="https://go.xero.com/AccountsPayable/ViewCreditNote.aspx?creditNoteID={{ row.xero_credit_note_id }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary text-nowrap px-2 py-0">Open</a>
                    {% elif row.xero_invoice_id %}
                      <a href="https://go.xero.com/AccountsPayable/View.aspx?InvoiceID={{ row.xero_invoice_id }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary text-nowrap px-2 py-0">Open</a>
                    {% else %}
                      â€”
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {% if row.statement_item_id %}
                      {% if row.is_completed %}
                        <form method="post" class="d-inline">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="action" value="incomplete_item">
                          <input type="hidden" name="statement_item_id" value="{{ row.statement_item_id }}">
                          <input type="hidden" name="items_view" value="{{ items_view }}">
                          <input type="hidden" name="show_payments" value="{{ 'true' if show_payments else 'false' }}">
                          <button type="submit" class="btn btn-sm btn-outline-warning text-nowrap px-2 py-0">Mark incomplete</button>
                        </form>
                      {% else %}
                        <form method="post" class="d-inline">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="action" value="complete_item">
                          <input type="hidden" name="statement_item_id" value="{{ row.statement_item_id }}">
                          <input type="hidden" name="items_view" value="{{ items_view }}">
                          <input type="hidden" name="show_payments" value="{{ 'true' if show_payments else 'false' }}">
                          <button type="submit" class="btn btn-sm btn-outline-success text-nowrap px-2 py-0">Mark complete</button>
                        </form>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">Unavailable</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="{{ statement_col_count * 2 + 3 }}" class="text-center text-muted">
                  {% if items_view == 'completed' %}
                    No completed statement items found.
                  {% elif items_view == 'incomplete' %}
                    No incomplete statement items found.
                  {% else %}
                    No statement items found.
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mt-4 mb-5">
        <a href="{{ url_for('statements') }}" class="btn btn-outline-secondary">Back to statements</a>
        <div class="d-flex align-items-center gap-3">
          {% if is_completed %}
            <span class="badge bg-success fs-6">Completed</span>
            <form method="post" class="mb-0">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" value="mark_incomplete">
              <input type="hidden" name="show_payments" value="{{ 'true' if show_payments else 'false' }}">
              <button type="submit" class="btn btn-outline-warning text-nowrap px-3 py-1">Mark incomplete</button>
            </form>
          {% else %}
            <form method="post" class="mb-0">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" value="mark_complete">
              <input type="hidden" name="show_payments" value="{{ 'true' if show_payments else 'false' }}">
              <button type="submit" class="btn btn-success text-nowrap px-3 py-1">Complete statement</button>
            </form>
          {% endif %}
          <form method="post"action="{{ url_for('delete_statement', statement_id=statement_id) }}" class="mb-0" onsubmit="return confirm('Delete this statement? This cannot be undone.');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-outline-danger text-nowrap px-3 py-1">Delete statement</button>
          </form>
        </div>
      </div>
    {% endif %}
{% endblock %}
